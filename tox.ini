[tox]
envlist = unit, init, base, build, dotnet, python, node, go, openjdk, openjdk-devel, metadata, multistage
isolated_build = True

[testenv]
deps =
    pytest
    pytest-asyncio
    pytest-testinfra
    # psutil used to detect cpus
    pytest-xdist[psutil]
    pytest-custom_exit_code
    requests
allowlist_externals =
    docker
    podman
    buildah
passenv =
    CONTAINER_RUNTIME
    HOME
    USER
    XDG_CONFIG_HOME
    BCI_DEVEL_REPO
commands =
    # -n auto tells pytest to use as many processors as detected
    # to run all the tests from the module test_{envname} in parallel
    pytest -vv -n auto -m "not serial" test_{envname}.py --junitxml={toxinidir}/junit_parallel.xml []
    pytest -vv -n0 -m "serial" --suppress-no-test-exit-code test_{envname}.py --junitxml={toxinidir}/junit_serial.xml []

[testenv:unit]
commands =
    pytest -n auto test_unit.py --junitxml={toxinidir}/junit_unit.xml []

[testenv:format]
deps =
    black
    reorder-python-imports
commands =
    black . bci_tester []
    ./reorder_imports.sh

[testenv:venv]
passenv = *
commands = {posargs} []
