[tox]
envlist = {py36,py37,py38,py39,py310}-unit, build, all, base, init, dotnet, python, node, go, openjdk, openjdk-devel, metadata, minimal, multistage, repository
isolated_build = True

[testenv]
deps =
    pytest
    pytest-testinfra
    # psutil used to detect cpus
    pytest-xdist[psutil]
    pytest-custom_exit_code
    requests
    dataclasses ; python_version < "3.7"
    lxml
allowlist_externals =
    docker
    podman
    buildah
passenv =
    CONTAINER_RUNTIME
    HOME
    USER
    XDG_CONFIG_HOME
    BCI_DEVEL_REPO
    EXTRA_RUN_ARGS
    EXTRA_BUILD_ARGS
commands =
    # -n auto tells pytest to use as many processors as detected
    # to run all the tests from the module test_{envname} in parallel
    pytest -vv -n auto -m "not serial" test_{envname}.py --junitxml={toxinidir}/junit_{envname}_parallel.xml []
    pytest -vv -n0 -m "serial" --suppress-no-test-exit-code test_{envname}.py --junitxml={toxinidir}/junit_{envname}_serial.xml []

[testenv:{py36,py37,py38,py39,py310}-unit]
commands =
    pytest -n auto test_unit.py --junitxml={toxinidir}/junit_unit.xml []

[testenv:format]
deps =
    black
    reorder-python-imports
commands =
    black . bci_tester []
    ./reorder_imports.sh

[testenv:venv]
passenv = *
commands = {posargs} []
